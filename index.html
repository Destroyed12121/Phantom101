<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Unblocked</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5LMBC27Z');</script>
    <!-- End Google Tag Manager -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg, #0a0a0a);
            font-family: 'Inter', -apple-system, sans-serif;
        }

        /* First Visit Cloak Overlay */
        #fv-cloak {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 10000;
            display: none;
            /* Hidden by default, shown via script if needed */
        }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg, #0a0a0a);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-out;
        }

        .loading-logo {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .loading-logo i {
            color: var(--text-muted, #a1a1aa);
        }

        .loading-logo span {
            background: linear-gradient(90deg, var(--text, #e4e4e7) 0%, var(--text-muted, #a1a1aa) 40%, var(--text-dim, #52525b) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border, #1f1f1f);
            border-top-color: var(--text-muted, #71717a);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-dim, #52525b);
            font-size: 0.875rem;
        }

        .launch-screen {
            position: fixed;
            inset: 0;
            background: var(--bg, #0a0a0a);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .launch-screen.hidden {
            display: none;
        }

        .launch-button {
            background: var(--surface);
            color: var(--text-muted);
            border: none;
            padding: 24px 48px;
            border-radius: var(--radius-lg);
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-top: 16px;
            width: 100%;
            max-width: 300px;
            opacity: 0.75;
        }

        .launch-button:hover {
            opacity: 0.5;
        }


        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
    <script src="config.js"></script>
    <script src="scripts/settings.js"></script>
    <script src="scripts/cloak-init.js"></script>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5LMBC27Z" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- First Visit Cloak Layer -->
    <div id="fv-cloak"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-logo">
            <i class="fa-solid fa-ghost"></i>
            <span>Phantom</span>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Launch Screen -->
    <div id="launch-screen" class="launch-screen hidden">
        <div class="loading-logo">
            <i class="fa-solid fa-ghost"></i>
            <span>Phantom</span>
        </div>
        <button id="launch-button" class="launch-button"> Launch Phantom</button>
    </div>

    <iframe id="main-frame"></iframe>

    <!-- First Visit Cloak Logic -->
    <script>
        (function () {
            var STORAGE_KEY = 'phantom_fv';
            var overlay = document.getElementById('fv-cloak');
            var iframe = document.getElementById('main-frame');

            // Check for ?fake parameter
            const urlParams = new URLSearchParams(window.location.search);
            const isFakeMode = urlParams.has('fake');

            // Check config
            var cloakEnabled = window.SITE_CONFIG && window.SITE_CONFIG.firstVisitCloak !== false;
            var isCloaked = cloakEnabled && !localStorage.getItem(STORAGE_KEY) && !isFakeMode;

            if (isFakeMode) {
                // Show launch screen for ?fake mode
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('launch-screen').classList.remove('hidden');
                document.getElementById('launch-button').addEventListener('click', () => {
                    document.getElementById('launch-screen').classList.add('hidden');
                    // Load settings
                    let settings = {};
                    try { settings = JSON.parse(localStorage.getItem('void_settings') || '{}'); } catch { }
                    const cloakMode = settings.cloakMode || 'none';
                    const realUrl = window.location.href.replace(/\?fake/, '');
                    const doRedirect = () => {
                        const targets = ['https://www.youtube.com', 'https://edpuzzle.com'];
                        const randomTarget = targets[Math.floor(Math.random() * targets.length)];
                        window.location.replace(randomTarget);
                    };
                    let popupOpened = false;
                    if (cloakMode === 'blob') {
                        fetch(realUrl).then(r => r.text()).then(html => {
                            const blob = new Blob([html], { type: 'text/html' });
                            const win = window.open(URL.createObjectURL(blob), '_blank');
                            if (win) {
                                popupOpened = true;
                                doRedirect();
                            } else {
                                // Fallback
                                iframe.src = 'index2.html';
                            }
                        }).catch(() => {
                            // Fallback
                            iframe.src = 'index2.html';
                        });
                    } else if (cloakMode === 'about:blank') {
                        const win = window.open('about:blank', '_blank');
                        if (win) {
                            popupOpened = true;
                            win.document.open();
                            win.document.write('<iframe src="' + realUrl + '" style="position:fixed;inset:0;width:100%;height:100%;border:none;"></iframe>');
                            win.document.close();
                            // Copy disguised title/icon to new window
                            if (settings.tabTitle) win.document.title = settings.tabTitle;
                            if (settings.tabFavicon) {
                                const link = win.document.createElement('link');
                                link.rel = 'icon';
                                link.href = settings.tabFavicon;
                                win.document.head.appendChild(link);
                            }
                            doRedirect();
                        } else {
                            // Fallback
                            iframe.src = 'index2.html';
                        }
                    } else {
                        // No cloak, open directly
                        const win = window.open(realUrl, '_blank');
                        if (win) {
                            popupOpened = true;
                            doRedirect();
                        } else {
                            // Fallback
                            iframe.src = 'index2.html';
                        }
                    }
                    // If popup was opened, check if it closed
                    if (popupOpened) {
                        setTimeout(() => {
                            if (win && win.closed) {
                                // Show launch screen again or something
                            }
                        }, 1000);
                    }
                });
            } else if (isCloaked) {
                // Show white screen
                overlay.style.display = 'block';
                // Remove title tag to show URL/filename
                var titleTag = document.querySelector('title');
                if (titleTag) titleTag.remove();

                // Remove favicon tags to show default icon
                var iconLinks = document.querySelectorAll("link[rel*='icon']");
                iconLinks.forEach(l => l.remove());
                var link = document.createElement('link');
                link.rel = 'icon';
                link.href = 'data:image/x-icon;base64,'; // Empty
                document.getElementsByTagName('head')[0].appendChild(link);

                var onKey = function (e) {
                    if (e.key.toLowerCase() === 'c') {
                        // Uncloak
                        overlay.style.display = 'none';
                        localStorage.setItem(STORAGE_KEY, '1');
                        document.removeEventListener('keydown', onKey);
                        // Restore title
                        var newTitle = document.createElement('title');
                        newTitle.innerText = 'Phantom Unblocked';
                        document.head.appendChild(newTitle);

                        // Restore favicon
                        var newLink = document.createElement('link');
                        newLink.rel = 'icon';
                        newLink.href = 'favicon.svg';
                        newLink.type = 'image/svg+xml';
                        document.head.appendChild(newLink);

                        // Load the app content NOW
                        iframe.src = 'index2.html';

                        // Analytics
                        window.dataLayer = window.dataLayer || [];
                        window.dataLayer.push({ event: 'cloak_bypass_pressed' });
                        if (typeof gtag === 'function') {
                            gtag('event', 'cloak_bypass', {
                                'event_category': 'engagement',
                                'event_label': 'first_visit_cloak'
                            });
                        }
                    }
                };
                document.addEventListener('keydown', onKey);
            } else {
                // No cloak needed, load immediately
                iframe.src = 'index2.html';
            }
        })();
    </script>

    <script>
        const loadingScreen = document.getElementById('loading-screen');
        const iframe = document.getElementById('main-frame');
        let loadStartTime = Date.now();
        let fallbackTimer = setTimeout(hideLoading, 3500);

        function showLoading() {
            loadingScreen.classList.remove('hidden');
            loadStartTime = Date.now();

            clearTimeout(fallbackTimer);
            fallbackTimer = setTimeout(hideLoading, 3500);
        }

        function hideLoading() {
            clearTimeout(fallbackTimer);

            // Min time 0.5s (500ms)
            const minTime = 500;
            const elapsed = Date.now() - loadStartTime;
            const remaining = Math.max(0, minTime - elapsed);

            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, remaining);

            // Re-attach listener to the new window for next navigation
            try {
                if (iframe.contentWindow) {
                    iframe.contentWindow.removeEventListener('unload', showLoading);
                    iframe.contentWindow.addEventListener('unload', () => {
                        requestAnimationFrame(showLoading);
                    });
                }
            } catch (e) { }
        }

        // Listen for iframe load events
        iframe.addEventListener('load', hideLoading);

        // Expose to children if needed
        window.showLoading = showLoading;
        window.hideLoading = hideLoading;
    </script>

    <script src="scripts/cloaking.js"></script>
    <script>
        (function () {
            const STORAGE_KEY = 'void_settings';

            // Cloak application handled by scripts/cloaking.js automatically now

            // Handle about:blank / blob mode on startup
            let settings = {};
            try { settings = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { }
            const cloakMode = settings.cloakMode || 'none';

            // Check for ?fake parameter
            const urlParams = new URLSearchParams(window.location.search);
            const isFakeMode = urlParams.has('fake');

            if (isFakeMode) {
                // Show launch screen for ?fake mode
                showLaunchScreen();
            } else if (window.top === window.self && cloakMode !== 'none') {
                const currentUrl = window.location.href;
                const doRedirect = () => {
                    const targets = ['https://www.youtube.com', 'https://edpuzzle.com'];
                    const randomTarget = targets[Math.floor(Math.random() * targets.length)];
                    window.location.replace(randomTarget);
                };

                let popupOpened = false;

                if (cloakMode === 'blob') {
                    fetch(currentUrl).then(r => r.text()).then(html => {
                        const blob = new Blob([html], { type: 'text/html' });
                        const win = window.open(URL.createObjectURL(blob), '_blank');
                        if (win) {
                            popupOpened = true;
                            doRedirect();
                        } else {
                            showLaunchScreen();
                        }
                    }).catch(() => {
                        showLaunchScreen();
                    });
                } else if (cloakMode === 'about:blank') {
                    const win = window.open('about:blank', '_blank');
                    if (win) {
                        popupOpened = true;
                        win.document.open();
                        win.document.write('<iframe src="' + currentUrl + '" style="position:fixed;inset:0;width:100%;height:100%;border:none;"></iframe>');
                        win.document.close();

                        // Copy disguised title/icon to new window
                        if (settings.tabTitle) win.document.title = settings.tabTitle;
                        if (settings.tabFavicon) {
                            const link = win.document.createElement('link');
                            link.rel = 'icon';
                            link.href = settings.tabFavicon;
                            win.document.head.appendChild(link);
                        }
                        doRedirect();
                    } else {
                        showLaunchScreen();
                    }
                }

                // If popup was opened, check if it closed
                if (popupOpened) {
                    setTimeout(() => {
                        if (win && win.closed) {
                            showLaunchScreen();
                        }
                    }, 1000);
                }
            }

            function showLaunchScreen() {
                document.getElementById('launch-screen').classList.remove('hidden');
                document.getElementById('launch-button').addEventListener('click', () => {
                    document.getElementById('launch-screen').classList.add('hidden');
                    // Load the app content
                    document.getElementById('main-frame').src = 'index2.html';
                });
            }
        })();
    </script>
</body>

</html>