<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Unblocked</title>
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/Destroyed12121/Phantom101@main/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5LMBC27Z');</script>
    <!-- End Google Tag Manager -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg, #0a0a0a);
            font-family: 'Inter', -apple-system, sans-serif;
        }


        .loading-screen {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }

        .loading-logo {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .loading-logo i {
            color: var(--text-muted, #a1a1aa);
        }

        .loading-logo span {
            background: linear-gradient(90deg, var(--text, #e4e4e7) 0%, var(--text-muted, #a1a1aa) 40%, var(--text-dim, #52525b) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border, #1f1f1f);
            border-top-color: var(--text-muted, #71717a);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-dim, #52525b);
            font-size: 0.875rem;
        }


        .launch-screen {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .launch-screen.hidden {
            display: none;
        }

        .launch-button {
            background: var(--surface);
            color: var(--text-muted);
            border: none;
            padding: 24px 48px;
            border-radius: var(--radius-lg);
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-top: 16px;
            width: 100%;
            max-width: 300px;
            opacity: 0.75;
        }

        .launch-button:hover {
            opacity: 0.5;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Panic white screen */
        #panic-overlay {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 99999;
            display: none;
        }
    </style>
    <script>
// Inlined config.js
// site config

window.SITE_CONFIG = {
    name: "Phantom",
    fullName: "Phantom Unblocked",
    version: "1.0.11",

    changelog: [
        "some code consolidation and fixxes",
        "suggest features in the discord server"
    ],

    // quotes
    quotes: [
        "so tuff",
        "it is what it is",
        "do ur work",
        "this is what happens when u dont touch grass",
        "FULL BOX",
        "FULL PIECE",
        "200!",
        "press esc + refresh + power button for hacks",
        "press ctrl+x to hide your screen",
        "change the tab title and favicon in settings",
        "TEACHERR!",
        "lebron lebron lebronn james",
        "lebron is OUR goat",
        "stop looking at my screen",
    ],

    // todo
    // *** for strikethrough
    // ** for bold
    todos: [
        "***fix the proxy***",
        "***fix panic panickey, add quote talking about it***",
        "***fix theatermode, make it hide buttons after a few seconds and ensure all content is being displayed and move the description to the bottom***",
        "***change back player to use old styling, change the surface to use background colors for the bottom part where description is shown, looking just like the background***",
        "***add image and video support for backgrounds***",
        "***fix aichat, make the title use the same ai request as the users question unless its in image mode where it will use text mode and fix ai chat to remember modes better***",
        "***add cloaking to quotes***",
        "***add a default cloak and fix it so icons work in aboutblank for whatever reason they only work when you go to settings in aboutblank where it correctly applies***",
        "***for search suggestions add highlighting for whatever will happen when you click enter, in search suggestions fix all games not sending you to the games page***",
        "***fix games to make multi library the default, put it in config.js***",
        "**rename movies shortcut in index2.html to primeshows, add shortcuts to main pages in the topbar and change the current shortcuts to more popular games**",
        "***make announcements show even on first visit unlike changelog and allow disabling it via settings***",
        "***fix leave comformation asking u to leave each time you click something***",
        "***change the shortcuts on the main page to include pages***",
        "***add movies to the search bar in main page***",
        "***fix background not turning off soon***",
        "**fix music page to hide youtube player unless toggled via 3 dot small button, and always shown on proxy mode, fix all the controls for video time, volume**",
        "**add singlefile using cdns for each page so it autoupdates and is easy enough to make**",
        "**advertise phantom (too much work tbh)**",
        "**add a watch page for youtube and twitch**",
        "**add a miniplayer for music**",
        "***shorten some page's code***",
        "**fix paths in search autocomplete**",
        "**fix markdown in ai not using correct text colors**",
        "**make backgrounds show in the loading screen**",
        "**fix icons for topbar in code.html**",
        "**fix wisp server not notifying or autoswitiching when offline in proxy**",
        "**fix code runner open not working at all**",
        "**make backgrounds show in player.html**",
        "**make backgrounds show in staticsjv2**",
        "***make player.html player controls use theme colros not hardcoded***",
        "***make ai chat and music sidebar go all the way down and up with borders***",
        "**make the only song in music be lebron lebron lebron james**",
        "***finish extra page into credits and make this todo be tucked away somewhere and not the main part of it***"
    ],
    defaultWisp: "wss://glseries.net/wisp/",
    wispServers: [
        { name: "GLSeries Wisp", url: "wss://glseries.net/wisp/" },
        { name: "Rhw's Wisp", url: "wss://wisp.rhw.one/" },
    ],

    discord: {
        inviteUrl: "https://discord.gg/tHWx9NXp5p",
        widgetServer: "1447673724017971324",
        widgetChannel: "1447673726228496617",
    },

    firstVisitCloak: false, //fake error page
    defaults: {
        cloakMode: "about:blank",
        tabTitle: "You've already responded",
        tabFavicon: "https://ssl.gstatic.com/docs/spreadsheets/forms/forms_icon_2023q4.ico",
        cloakRotation: false,
        cloakInterval: 5000,
        panicKey: "x",
        panicModifiers: ["ctrl", "shift"],
        panicUrl: "https://classroom.google.com",
        maxMovieRating: "R",
        gameLibrary: "multi",
        discordWidget: true,
        miniplayer: true,
        leaveConfirmation: false,
        showChangelogOnUpdate: true,
        themeRotation: true,
        lastThemeRotation: 0,
        backgroundRotation: true,
        lastBackgroundRotation: 0,
        lastSeenFeatured: 'none',
        background: { type: 'color', value: '#0a0a0a' },
        customBackground: { id: 'none', type: 'none' },
        accentColor: '#ffffff',
        surfaceColor: '#0f0f0f',
        secondaryColor: '#2e2e33',
        textColor: '#e4e4e7',
    },

    themePresets: {
        dark: { name: 'Dark (Default)', bg: { type: 'color', value: '#0a0a0a' }, surface: '#0f0f0f', surfaceHover: '#1a1a1a', surfaceActive: '#252525', secondary: '#2e2e33', border: '#2a2a2a', borderLight: '#2a2a2a', text: '#e4e4e7', textSec: '#71717a', textDim: '#52525b', accent: '#ffffff' },
        midnight: { name: 'Midnight', bg: { type: 'color', value: '#000000' }, surface: '#050505', surfaceHover: '#111111', surfaceActive: '#1a1a1a', secondary: '#111111', border: '#1a1a1a', borderLight: '#111111', text: '#ededed', textSec: '#a3a3a3', textDim: '#737373', accent: '#d4d4d4' },
        abyss: { name: 'Abyss', bg: { type: 'color', value: '#020617' }, surface: '#0f172a', surfaceHover: '#1e293b', surfaceActive: '#334155', secondary: '#1e293b', border: '#1e293b', borderLight: '#1e293b', text: '#f1f5f9', textSec: '#94a3b8', textDim: '#64748b', accent: '#38bdf8' },
        phantom: { name: 'Phantom', bg: { type: 'color', value: '#0f0a14' }, surface: '#1a0f24', surfaceHover: '#2e1a40', surfaceActive: '#4c2a5c', secondary: '#2e1a40', border: '#2e1a40', borderLight: '#2e1a40', text: '#f3e8ff', textSec: '#d8b4fe', textDim: '#c084fc', accent: '#c084fc' },
        rosepine: { name: 'Rose Pine', bg: { type: 'color', value: '#191724' }, surface: '#1f1d2e', surfaceHover: '#26233a', surfaceActive: '#524f67', secondary: '#26233a', border: '#26233a', borderLight: '#1f1d2e', text: '#e0def4', textSec: '#908caa', textDim: '#6e6a86', accent: '#ebbcba' },
        ocean: { name: 'Oceanic', bg: { type: 'color', value: '#011627' }, surface: '#0b2942', surfaceHover: '#1d3b53', surfaceActive: '#2d4b63', secondary: '#0b2942', border: '#1d3b53', borderLight: '#0b2942', text: '#d6deeb', textSec: '#5f7e97', textDim: '#011627', accent: '#7fdbca' },
        forest: { name: 'Forest', bg: { type: 'color', value: '#020d06' }, surface: '#051a0d', surfaceHover: '#0a2e17', surfaceActive: '#0f4221', secondary: '#051a0d', border: '#0a2e17', borderLight: '#051a0d', text: '#ecfdf5', textSec: '#6ee7b7', textDim: '#064e3b', accent: '#10b981' },
        crimson: { name: 'Crimson', bg: { type: 'color', value: '#1a0505' }, surface: '#230a0a', surfaceHover: '#7b0a0aff', surfaceActive: '#7f1d1d', secondary: '#230a0a', border: '#480f0fff', borderLight: '#230a0a', text: '#fef2f2', textSec: '#fecaca', textDim: '#450a0a', accent: '#ef4444' },
        flame: { name: 'Flame', bg: { type: 'color', value: '#0c0202' }, surface: '#1c0a0a', surfaceHover: '#451a03', surfaceActive: '#9a3412', secondary: '#1c0a0a', border: '#451a03', borderLight: '#9a3412', text: '#fff7ed', textSec: '#fdba74', textDim: '#ea580c', accent: '#f59e0b' }
    },

    backgroundPresets: [
        { id: 'none', name: 'None (Theme Default)', type: 'none' },
        { id: 'Night sky', name: 'Night sky', type: 'image', url: 'https://images.pexels.com/photos/5675745/pexels-photo-5675745.jpeg', overlay: 0.3 },
        { id: 'winter-mountains', name: 'Winter mountains', type: 'image', url: 'https://images.pexels.com/photos/1287145/pexels-photo-1287145.jpeg', overlay: 0.3 },
        { id: 'f1 car', name: 'F1 Car', type: 'image', url: 'https://images.pexels.com/photos/14401632/pexels-photo-14401632.jpeg', overlay: 0.3 },
        { id: 'moon-landing', name: 'Moon Landing', type: 'image', url: 'https://images.pexels.com/photos/41162/moon-landing-apollo-11-nasa-buzz-aldrin-41162.jpeg', overlay: 0.3, objectPosition: 'top left', active: true },
        { id: 'turtle', name: 'Turtle', type: 'image', url: 'https://images.unsplash.com/photo-1501791187590-9ef2612ba1eb?q=80&w=1932&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', overlay: 0.3 },
        { id: 'road', name: 'Road', type: 'image', url: 'https://images.unsplash.com/photo-1508233620467-f79f1e317a05', overlay: 0.3 },
        { id: 'railroad', name: 'Railroad', type: 'image', url: 'https://images.unsplash.com/photo-1505832018823-50331d70d237', overlay: 0.3 },
        { id: 'mountain', name: 'Mountain', type: 'image', url: 'https://raw.githubusercontent.com/evanhnry/brave-wallpapers/refs/heads/main/Brave/clay-banks-u27Rrbs9Dwc-unsplash.jpg', overlay: 0.3 },
    ],

    cloakPresets: [
        { name: "Phantom", icon: "/favicon.svg", title: "Phantom Unblocked" },
        { name: "Edpuzzle", icon: "https://edpuzzle.imgix.net/favicons/favicon-32.png", title: "Edpuzzle" },
        { name: "Google Docs", icon: "https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico", title: "Untitled document - Google Docs" },
        { name: "Canvas", icon: "https://du11hjcvx0uqb.cloudfront.net/dist/images/favicon-e10d657a73.ico", title: "Dashboard" },
        { name: "Desmos", icon: "https://www.desmos.com/favicon.ico", title: "Desmos | Graphing Calculator" },
        { name: "Khan Academy", icon: "https://cdn.kastatic.org/images/favicon.ico", title: "Khan Academy" },
        { name: "Wikipedia", icon: "https://en.wikipedia.org/favicon.ico", title: "World War II - Wikipedia" },
        { name: "Classroom", icon: "https://ssl.gstatic.com/classroom/favicon.png", title: "Home - Classroom" },
        { name: "Canva", icon: "https://static.canva.com/static/images/android-192x192-2.png", title: "Home - Canva" },
        { name: "Quiz", icon: "https://ssl.gstatic.com/docs/spreadsheets/forms/forms_icon_2023q4.ico", title: "You've already responded" },
        { name: "Blooket", icon: "https://play.blooket.com/favicon.ico", title: "Play Blooket | Blooket" },
        { name: "Gmail", icon: "https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico", title: "Gmail" },
        { name: "YouTube", icon: "https://www.youtube.com/favicon.ico", title: "YouTube" },
        { name: "Powerschool", icon: "https://waverlyk12.powerschool.com/favicon.ico", title: "Grades and Attendance" },
        { name: "nothing", icon: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=", title: "\u200B" },
    ]
}



</script>
    <script>
// Inlined scripts/settings.js
// settings handler
(function () {
    'use strict';

    const STORAGE_KEY = 'void_settings';

    const getDefaults = () => {
        return window.SITE_CONFIG?.defaults || {
            cloakMode: 'none',
            cloakRotation: false,
            cloakInterval: 5000,
            panicKey: 'x',
            panicModifiers: ['ctrl', 'shift'],
            panicUrl: 'https://classroom.google.com',
            maxMovieRating: 'R',
            offlineGames: [],
            gameLibrary: 'multi',
            leaveConfirmation: false
        };
    };

    const load = () => {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                return { ...getDefaults(), ...JSON.parse(stored) };
            }
        } catch (e) {
            console.warn('Failed to load settings:', e);
        }
        return getDefaults();
    };

    const save = (settings) => {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            window.dispatchEvent(new CustomEvent('settings-changed', { detail: settings }));
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'settings-update' }, '*');
            }
        } catch (e) {
            console.warn('Failed to save settings:', e);
        }
    };

    let _settings = load();

    window.Settings = {
        get(key) { return _settings[key]; },

        getAll() { return { ..._settings }; },

        set(key, value) {
            _settings[key] = value;
            save(_settings);
            this.apply();
            return value;
        },

        update(partial) {
            _settings = { ..._settings, ...partial };
            save(_settings);
            this.apply();
        },

        reset() {
            _settings = getDefaults();
            save(_settings);
            this.apply();
        },

        apply() {
            const root = document.documentElement;
            const s = _settings;
            const d = window.SITE_CONFIG?.defaults || {};

            const vars = {
                '--accent': s.accentColor || d.accentColor || '#ffffff',
                '--surface': s.surfaceColor || d.surfaceColor || '#0f0f0f',
                '--surface-hover': s.surfaceHoverColor || d.surfaceHoverColor || '#1a1a1a',
                '--surface-active': s.surfaceActiveColor || d.surfaceActiveColor || '#252525',
                '--secondary': s.secondaryColor || d.secondaryColor || '#2e2e33',
                '--border': s.borderColor || d.borderColor || '#1f1f1f',
                '--border-light': s.borderLightColor || d.borderLightColor || '#2a2a2a',
                '--text': s.textColor || d.textColor || '#e4e4e7',
                '--text-muted': s.textSecondaryColor || d.textSecondaryColor || '#71717a',
                '--text-dim': s.textDimColor || d.textDimColor || '#52525b',
                '--toggle': s.toggleColor || d.toggleColor,
                '--toggle-knob': s.toggleKnobColor || d.toggleKnobColor
            };

            Object.entries(vars).forEach(([key, val]) => {
                if (val) root.style.setProperty(key, val);
            });

            const themeBg = s.background || d.background || { type: 'color', value: '#0a0a0a' };
            const customBg = s.customBackground;
            const isCustomActive = customBg && customBg.type !== 'none';

            if (themeBg.type === 'color') {
                root.style.setProperty('--bg', themeBg.value);
            }

            if (isCustomActive && customBg.url) {
                root.style.setProperty('--bg-image', `url(${customBg.url})`);

                let position = customBg.objectPosition;
                if (customBg.id && customBg.id !== 'custom') {
                    const preset = window.SITE_CONFIG?.backgroundPresets?.find(b => b.id === customBg.id);
                    if (preset?.objectPosition) position = preset.objectPosition;
                }

                root.style.setProperty('--bg-image-position', position || 'center');
            } else if (themeBg.type === 'image' || themeBg.type === 'video') {
                root.style.setProperty('--bg-image', `url(${themeBg.value || themeBg.url})`);
                root.style.setProperty('--bg-image-position', themeBg.objectPosition || 'center');
            } else if (themeBg.type === 'gradient') {
                root.style.setProperty('--bg-image', themeBg.value || themeBg.url);
                root.style.setProperty('--bg-image-position', 'center');
            } else {
                root.style.setProperty('--bg-image', 'none');
            }
        },

        onChange(callback) {
            window.addEventListener('settings-changed', (e) => callback(e.detail));
        },

        isRatingAllowed(rating) {
            if (!rating || rating === 'NR' || rating === 'NC-17') return false;
            const ratingOrder = ['G', 'PG', 'PG-13', 'R'];
            const maxIndex = ratingOrder.indexOf(_settings.maxMovieRating);
            const ratingIndex = ratingOrder.indexOf(rating);
            return maxIndex !== -1 && ratingIndex !== -1 && ratingIndex <= maxIndex;
        }
    };

    // panic button go brr
    const handlePanic = (e) => {
        const mods = _settings.panicModifiers || [];
        const key = _settings.panicKey || 'x';

        if (mods.includes('ctrl') !== e.ctrlKey) return;
        if (mods.includes('shift') !== e.shiftKey) return;
        if (mods.includes('alt') !== e.altKey) return;

        if (e.key.toLowerCase() === key.toLowerCase()) {
            e.preventDefault();
            const overlayId = 'panic-overlay';
            let overlay = window.parent?.document?.getElementById(overlayId) || document.getElementById(overlayId);

            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = overlayId;
                overlay.style.cssText = 'position:fixed;inset:0;background:white;z-index:99999;';
                document.body.appendChild(overlay);
            } else {
                overlay.style.display = 'block';
            }

            window.location.replace(_settings.panicUrl || 'https://classroom.google.com');
        }
    };

    const init = () => {
        Settings.apply();

        const featured = window.SITE_CONFIG?.featuredBackground;
        const activePreset = window.SITE_CONFIG?.backgroundPresets?.find(p => p.active);

        const target = activePreset || featured;

        if (target?.id && target.id !== _settings.lastSeenFeatured) {
            Settings.update({
                customBackground: target,
                lastSeenFeatured: target.id,
                backgroundRotation: false
            });
        }

        document.addEventListener('keydown', handlePanic, true);

        window.addEventListener('storage', (e) => {
            if (e.key === STORAGE_KEY) {
                _settings = load();
                Settings.apply();
                window.dispatchEvent(new CustomEvent('settings-changed', { detail: _settings }));
            }
        });

        window.addEventListener('message', (e) => {
            if (e.data?.type === 'settings-update' || e.data === 'updateCloak') {
                _settings = load();
                Settings.apply();
                window.dispatchEvent(new CustomEvent('settings-changed', { detail: _settings }));
            }
        });

        window.addEventListener('beforeunload', (e) => {
            if (document.getElementById('main-frame') && _settings.leaveConfirmation) {
                e.preventDefault();
                return e.returnValue = '';
            }
        });
    };

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
})();

</script>
    <script>
// Inlined scripts/background.js
// background stuff
(function () {
    'use strict';

    if (window.BackgroundManager) return;

    const YOUTUBE_REGEX = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/;

    const BackgroundManager = {
        container: null,
        mediaLayer: null,
        elements: { video: null, image: null, iframe: null },
        current: { type: null, url: null },
        cacheName: 'phantom-bg-cache-v2',

        init() {
            this.container = document.createElement('div');
            this.container.className = 'phantom-background';
            this.container.innerHTML = '<div class="phantom-background-overlay"></div><div class="phantom-background-layer"></div>';
            this.mediaLayer = this.container.querySelector('.phantom-background-layer');
            document.body.insertBefore(this.container, document.body.firstChild);

            const apply = () => this.applyBackground();
            window.addEventListener('settings-changed', apply);
            window.addEventListener('storage', apply);
            window.addEventListener('beforeunload', () => this.cleanup());
            window.addEventListener('pagehide', () => this.cleanup());

            document.addEventListener('visibilitychange', () => {
                const video = this.elements.video;
                if (!video) return;
                if (document.hidden) video.pause();
                else if (this.current.type === 'video') video.play().catch(() => { });
            });

            this.applyBackground();
        },

        applyBackground() {
            if (!this.container) return; // Wait for init() to create the container

            const s = window.Settings?.getAll() || {};
            const custom = s.customBackground;
            const theme = s.background || {};

            let type = null, url = null, pos = null, overlay = 0.4;

            if (custom && custom.type !== 'none') {
                // Refresh from config if possible to get latest props like objectPosition
                if (custom.id && custom.id !== 'custom') {
                    const preset = window.SITE_CONFIG?.backgroundPresets?.find(b => b.id === custom.id);
                    if (preset) Object.assign(custom, preset);
                }
                ({ type, url, objectPosition: pos, overlay = 0.4 } = custom);
            } else if (theme.type === 'image' || theme.type === 'video' || theme.type === 'youtube') {
                type = theme.type;
                url = theme.value || theme.url;
                pos = theme.objectPosition;
                overlay = theme.overlay || 0.4;
            }

            document.documentElement.style.setProperty('--bg-overlay', overlay);

            // Handle common positioning typos and normalize
            if (pos && typeof pos === 'string') {
                pos = pos.toLowerCase().trim()
                    .replace(/\s+/g, ' ') // Normalize multiple spaces
                    .replace('topleft', 'top left')
                    .replace('topright', 'top right')
                    .replace('bottomleft', 'bottom left')
                    .replace('bottomright', 'bottom right')
                    .replace('centercenter', 'center')
                    .replace('centerleft', 'center left')
                    .replace('centerright', 'center right');
            }

            document.documentElement.style.setProperty('--bg-image-position', pos || 'center');

            if (!type || !url) {
                this.clear();
                document.documentElement.style.backgroundColor = 'var(--bg)';
                document.documentElement.style.setProperty('--bg-image-position', 'center');
                return;
            }
            if (this.current.type === type && this.current.url === url) return;

            this.current = { type, url };

            if (type === 'video' || url.match(/\.(mp4|webm|ogg|mov|m4v)$/i)) {
                this.clearMedia();
                this.createVideo(url, pos);
                this.container.classList.add('active');
                document.documentElement.classList.add('phantom-bg-active');
                document.body.classList.add('phantom-bg-active');
            } else if (type === 'youtube' || YOUTUBE_REGEX.test(url)) {
                this.clearMedia();
                this.createYouTube(url, pos);
                this.container.classList.add('active');
                document.documentElement.classList.add('phantom-bg-active');
                document.body.classList.add('phantom-bg-active');
            } else if (type === 'image') {
                this.handleImageBackground(url, pos);
            }
        },

        async getProxiedCachedUrl(url) {
            // Local images don't need proxying
            if (!url.startsWith('http') || url.includes(location.hostname)) return url;

            // Try direct load first (faster)
            try {
                const directTest = await fetch(url, { method: 'HEAD', mode: 'cors' });
                if (directTest.ok) return url;
            } catch (e) {
                // CORS blocked, need to proxy
            }

            // Wait for BareMux (max 500ms)
            let retries = 0;
            while (!window.BareMux && retries < 5) {
                await new Promise(r => setTimeout(r, 100));
                retries++;
            }

            if (!window.BareMux) {
                console.warn("Background: BareMux not found, trying direct URL.");
                return url; // Try direct anyway
            }

            try {
                const client = new window.BareMux.BareClient();
                const response = await client.fetch(url);
                if (!response.ok) throw new Error('Proxy fetch failed');

                const blob = await response.blob();
                return URL.createObjectURL(blob);
            } catch (error) {
                console.error("Background proxy failed:", error);
                return url; // Fallback to direct URL
            }
        },

        async handleImageBackground(url, pos) {
            // Pre-load the image (proxied/cached or direct)
            const finalUrl = await this.getProxiedCachedUrl(url);

            // Check if this is still the current background after async fetch
            if (this.current.url !== url) {
                if (finalUrl && finalUrl.startsWith('blob:')) URL.revokeObjectURL(finalUrl);
                return;
            }

            this.clearMedia();
            this.createImage(finalUrl, pos);
        },

        createVideo(url, pos) {
            const el = Object.assign(document.createElement('video'), {
                className: 'phantom-background-media', src: url, autoplay: true, loop: true, muted: true, playsInline: true, volume: 0
            });
            // Apply objectPosition from settings/preset
            if (pos) el.style.objectPosition = pos;
            el.onerror = () => (this.elements.video = null);
            this.elements.video = el;
            this.mediaLayer.appendChild(el);
        },

        createImage(url, pos) {
            const el = Object.assign(document.createElement('img'), {
                className: 'phantom-background-media',
                src: url
            });

            // Apply objectPosition from settings/preset
            if (pos) el.style.objectPosition = pos;

            el.onload = () => {
                if (this.current.url === url || url.startsWith('blob:')) {
                    this.container.classList.add('active');
                    document.documentElement.classList.add('phantom-bg-active');
                    document.body.classList.add('phantom-bg-active');
                }
            };
            el.onerror = () => {
                console.warn("Background image failed to load:", url);
                if (this.elements.image === el) this.elements.image = null;
            };

            this.elements.image = el;
            this.mediaLayer.appendChild(el);
        },

        // youtube logic
        createYouTube(url, pos) {
            const id = url.match(YOUTUBE_REGEX)?.[1];
            if (!id) return;
            const el = Object.assign(document.createElement('iframe'), {
                className: 'phantom-background-media',
                src: `https://www.youtube.com/embed/${id}?autoplay=1&loop=1&playlist=${id}&controls=0&modestbranding=1&rel=0&mute=1&enablejsapi=1`,
                allow: 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'
            });
            // Apply objectPosition from settings/preset
            if (pos) el.style.objectPosition = pos;
            this.elements.iframe = el;
            this.mediaLayer.appendChild(el);
        },

        clearMedia() {
            Object.entries(this.elements).forEach(([key, el]) => {
                if (!el) return;
                if (key === 'video') { el.pause(); el.src = ''; }
                if (key === 'iframe') el.src = 'about:blank';
                if (key === 'image' && el.src.startsWith('blob:')) {
                    URL.revokeObjectURL(el.src);
                }
                el.remove();
                this.elements[key] = null;
            });
        },

        clear() {
            this.clearMedia();
            this.current = { type: null, url: null };
            document.documentElement.classList.remove('phantom-bg-active');
            document.body.classList.remove('phantom-bg-active');
            document.documentElement.style.backgroundColor = '';
            if (this.container) this.container.classList.remove('active');
        },

        cleanup() {
            this.clearMedia();
        }
    };

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => BackgroundManager.init());
    else BackgroundManager.init();

    window.BackgroundManager = BackgroundManager;
})();

</script>
    <script src="https://cdn.jsdelivr.net/gh/Destroyed12121/Phantom101@main/scripts/cloaking.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Destroyed12121/Phantom101@main/scripts/quotes.js"></script>
    <script>Settings.apply();</script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Destroyed12121/Phantom101@main/styles/error.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Destroyed12121/Phantom101@main/styles/background.css">

</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5LMBC27Z" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>

    <!-- First Visit Cloak Layer -->
    <div id="fv-cloak" class="neterror">
        <div id="main-frame-error" class="interstitial-wrapper">
            <div id="main-content">
                <div class="icon icon-generic"></div>
                <div id="main-message">
                    <h1>
                        <span>This site can’t be reached</span>
                    </h1>
                    <p>
                        <strong id="origin-text"></strong>’s <abbr id="dnsDefinition">DNS address</abbr> could not be
                        found.
                        Diagnosing the problem.
                    </p>
                    <div class="error-code">DNS_PROBE_POSSIBLE</div>
                </div>
            </div>
            <div id="buttons" class="nav-wrapper suggested-left">
                <div id="control-buttons">
                    <button id="reload-button" class="text-button" onclick="location.reload()">Reload</button>
                </div>
            </div>
        </div>
        <script>
            {
                const origin = window.location.hostname || "This site";
                document.getElementById("origin-text").textContent = origin;

                // Immediate cloak check to prevent flash
                try {
                    const STORAGE_KEY = 'phantom_fv';
                    const hasBypassed = localStorage.getItem(STORAGE_KEY);
                    const urlParams = new URLSearchParams(window.location.search);
                    const isFakeMode = urlParams.has('fake');

                    if (window.SITE_CONFIG.firstVisitCloak && !hasBypassed && !isFakeMode) {
                        const overlay = document.getElementById('fv-cloak');
                        if (overlay) overlay.style.display = 'block';
                        document.title = origin;

                        // Remove favicon for fake error page
                        document.querySelectorAll("link[rel*='icon']").forEach(l => l.remove());
                        const link = document.createElement('link');
                        link.rel = 'icon';
                        link.href = 'data:,';
                        document.head.appendChild(link);

                        // Hide loading screen immediately if possible
                        const style = document.createElement('style');
                        style.innerHTML = '#loading-screen { display: none !important; }';
                        document.head.appendChild(style);

                        // Set up bypass on reload button
                        document.getElementById('reload-button').onclick = function () {
                            localStorage.setItem(STORAGE_KEY, 'true');
                            overlay.style.display = 'none';
                            document.getElementById('main-frame').src = 'https://cdn.jsdelivr.net/gh/Destroyed12121/Phantom101@main/index2.html';
                            document.title = 'Phantom Unblocked'; // Reset title

                            // Restore favicon
                            document.querySelectorAll("link[rel*='icon']").forEach(l => l.remove());
                            const link = document.createElement('link');
                            link.rel = 'icon';
                            link.href = 'favicon.svg';
                            document.head.appendChild(link);
                        };
                    } else {
                        // If no cloak, load main content immediately
                        document.getElementById('main-frame').src = 'https://cdn.jsdelivr.net/gh/Destroyed12121/Phantom101@main/index2.html';
                    }
                } catch (e) { }
            }
        </script>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-logo">
            <i class="fa-solid fa-ghost"></i>
            <span>Phantom</span>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Launch Screen -->
    <div id="launch-screen" class="launch-screen hidden">
        <div class="loading-logo">
            <i class="fa-solid fa-ghost"></i>
            <span>Phantom</span>
        </div>
        <button id="launch-button" class="launch-button"> Launch Phantom</button>
    </div>

    <!-- Panic White Screen Overlay -->
    <div id="panic-overlay"></div>

    <iframe id="main-frame"></iframe>

    <script src="https://cdn.jsdelivr.net/gh/Destroyed12121/Phantom101@main/scripts/index2.js"></script>

    <script>
        const loadingScreen = document.getElementById('loading-screen');
        const iframe = document.getElementById('main-frame');
        let loadStartTime = Date.now();
        let fallbackTimer = setTimeout(hideLoading, 3500);

        function showLoading() {
            loadingScreen.classList.remove('hidden');
            if (window.Quotes) window.Quotes.init(true);
            loadStartTime = Date.now();

            clearTimeout(fallbackTimer);
            fallbackTimer = setTimeout(hideLoading, 3500);
        }

        function hideLoading() {
            clearTimeout(fallbackTimer);

            // Min time 0.5s (500ms)
            const minTime = 500;
            const elapsed = Date.now() - loadStartTime;
            const remaining = Math.max(0, minTime - elapsed);

            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, remaining);

            // Re-attach listener to the new window for next navigation
            try {
                if (iframe.contentWindow) {
                    iframe.contentWindow.removeEventListener('unload', showLoading);
                    iframe.contentWindow.addEventListener('unload', () => {
                        requestAnimationFrame(showLoading);
                    });
                }
            } catch (e) { }
        }

        // Listen for iframe load events
        iframe.addEventListener('load', hideLoading);

        // Expose to children if needed
        window.showLoading = showLoading;
        window.hideLoading = hideLoading;

        console.log('press c to enter');
    </script>
</body>

</html>