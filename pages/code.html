<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor - Phantom</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../components/topbar.css">

    <!-- Load JSZip first (synchronous) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* ============================================
           CODE EDITOR LAYOUT
           ============================================ */
        .editor-page {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            padding-top: 60px;
        }

        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar - File Tree */
        .file-sidebar {
            width: 260px;
            min-width: 200px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .sidebar-actions {
            display: flex;
            gap: 4px;
        }

        .sidebar-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
        }

        .sidebar-btn:hover {
            background: var(--surface-hover);
            color: var(--text);
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-tree-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-dim);
            text-align: center;
            padding: 20px;
        }

        .file-tree-empty i {
            font-size: 2rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .file-tree-empty span {
            font-size: 0.75rem;
            line-height: 1.5;
        }

        .tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8125rem;
            color: var(--text-muted);
            transition: all 0.1s;
            user-select: none;
        }

        .tree-item:hover {
            background: var(--surface-hover);
            color: var(--text);
        }

        .tree-item.active {
            background: var(--surface-active);
            color: var(--text);
        }

        .tree-item.folder {
            font-weight: 500;
        }

        .tree-item i {
            width: 16px;
            text-align: center;
            font-size: 0.875rem;
        }

        .tree-item .file-icon {
            color: #3b82f6;
        }

        .tree-item .folder-icon {
            color: #f59e0b;
        }

        .tree-item .js-icon {
            color: #f7df1e;
        }

        .tree-item .html-icon {
            color: #e34f26;
        }

        .tree-item .css-icon {
            color: #1572b6;
        }

        .tree-item .json-icon {
            color: #f59e0b;
        }

        .tree-children {
            padding-left: 16px;
        }

        .tree-children.collapsed {
            display: none;
        }

        /* Drop zone styling */
        .file-tree.drag-over {
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed var(--info);
            border-radius: var(--radius-md);
        }

        /* Main Editor Area */
        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Editor Tabs */
        .editor-tabs {
            display: flex;
            align-items: center;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 8px;
            gap: 2px;
            overflow-x: auto;
            min-height: 40px;
        }

        .editor-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            font-size: 0.8125rem;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .editor-tab:hover {
            color: var(--text);
            background: var(--surface-hover);
        }

        .editor-tab.active {
            color: var(--text);
            border-bottom-color: var(--accent);
        }

        .editor-tab .close-tab {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .editor-tab:hover .close-tab {
            opacity: 1;
        }

        .editor-tab .close-tab:hover {
            background: var(--surface-active);
        }

        /* Monaco Editor Container */
        #monaco-container {
            flex: 1;
            overflow: hidden;
        }

        /* Toolbar */
        .editor-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            gap: 8px;
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text);
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .toolbar-btn:hover {
            background: var(--surface-active);
            border-color: var(--border-light);
        }

        .toolbar-btn.primary {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }

        .toolbar-btn.primary:hover {
            opacity: 0.9;
        }

        .toolbar-btn.success {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: #22c55e;
        }

        .toolbar-btn i {
            font-size: 0.875rem;
        }

        /* Terminal Panel */
        .terminal-panel {
            height: 200px;
            min-height: 100px;
            background: #0d0d0d;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: height 0.2s;
        }

        .terminal-panel.collapsed {
            height: 36px;
            min-height: 36px;
        }

        .terminal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .terminal-tabs {
            display: flex;
            gap: 16px;
        }

        .terminal-tab {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 0;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }

        .terminal-tab:hover {
            color: var(--text);
        }

        .terminal-tab.active {
            color: var(--text);
            border-bottom-color: var(--accent);
        }

        .terminal-content {
            flex: 1;
            padding: 12px 16px;
            font-family: var(--font-mono);
            font-size: 0.8125rem;
            color: #22c55e;
            overflow-y: auto;
            line-height: 1.6;
        }

        .terminal-panel.collapsed .terminal-content {
            display: none;
        }

        .terminal-line {
            margin-bottom: 4px;
            display: flex;
            gap: 8px;
        }

        .terminal-line.error {
            color: #ef4444;
        }

        .terminal-line.warning {
            color: #f59e0b;
        }

        .terminal-line.info {
            color: #3b82f6;
        }

        .terminal-line .line-num {
            color: var(--text-dim);
            min-width: 40px;
        }

        /* Problems panel */
        .problems-content {
            display: none;
        }

        .problems-content.active {
            display: block;
        }

        .problem-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.1s;
        }

        .problem-item:hover {
            background: var(--surface-hover);
        }

        .problem-item i {
            margin-top: 2px;
        }

        .problem-item.error i {
            color: #ef4444;
        }

        .problem-item.warning i {
            color: #f59e0b;
        }

        .problem-text {
            flex: 1;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        .problem-location {
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        /* Resize handle */
        .resize-handle {
            height: 4px;
            background: transparent;
            cursor: ns-resize;
            transition: background 0.15s;
        }

        .resize-handle:hover {
            background: var(--accent);
        }

        /* Language selector */
        .language-select {
            font-size: 0.75rem;
            padding: 4px 24px 4px 8px;
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
        }

        .language-select:hover {
            border-color: var(--border-light);
        }

        .language-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Error count badge */
        .error-badge {
            font-size: 0.625rem;
            padding: 2px 6px;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-radius: 10px;
            font-weight: 600;
        }

        .warning-badge {
            font-size: 0.625rem;
            padding: 2px 6px;
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border-radius: 10px;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <script src="../config.js"></script>
    <script src="../scripts/settings.js"></script>
    <script src="../scripts/notifications.js"></script>
    <script src="../components/topbar.js"></script>

    <div class="editor-page">
        <!-- Main Container -->
        <div class="editor-container">
            <!-- File Sidebar -->
            <div class="file-sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">Explorer</span>
                    <div class="sidebar-actions">
                        <button class="sidebar-btn" id="new-file-btn" title="New File">
                            <i class="fa-solid fa-file-circle-plus"></i>
                        </button>
                        <button class="sidebar-btn" id="new-folder-btn" title="New Folder">
                            <i class="fa-solid fa-folder-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="file-tree" id="file-tree">
                    <div class="file-tree-empty">
                        <i class="fa-solid fa-folder-open"></i>
                        <span>Drag & drop files or folders here<br>or click + to create new</span>
                    </div>
                </div>
            </div>

            <!-- Main Editor -->
            <div class="editor-main">
                <!-- Toolbar -->
                <div class="editor-toolbar">
                    <div class="toolbar-left">
                        <button class="toolbar-btn success" id="fix-code-btn">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            Fix Code
                        </button>
                        <button class="toolbar-btn" id="lint-btn">
                            <i class="fa-solid fa-bug"></i>
                            Check Errors
                        </button>
                        <select class="language-select" id="language-select">
                            <option value="javascript">JavaScript</option>
                            <option value="typescript">TypeScript</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="json">JSON</option>
                            <option value="python">Python</option>
                            <option value="markdown">Markdown</option>
                            <option value="plaintext">Plain Text</option>
                        </select>
                        <span class="error-badge" id="error-count" style="display:none">0 errors</span>
                        <span class="warning-badge" id="warning-count" style="display:none">0 warnings</span>
                    </div>
                    <div class="toolbar-right">
                        <button class="toolbar-btn" id="open-tab-btn" title="Open in New Tab">
                            <i class="fa-solid fa-up-right-from-square"></i>
                            Open in Tab
                        </button>
                        <button class="toolbar-btn" id="save-btn">
                            <i class="fa-solid fa-download"></i>
                            Save
                        </button>
                        <button class="toolbar-btn primary" id="export-btn">
                            <i class="fa-solid fa-file-zipper"></i>
                            Export Project
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="editor-tabs" id="editor-tabs">
                    <button class="editor-tab active" data-file="untitled.js">
                        <i class="fa-solid fa-file-code js-icon"></i>
                        untitled.js
                        <span class="close-tab"><i class="fa-solid fa-xmark"></i></span>
                    </button>
                </div>

                <!-- Monaco Editor -->
                <div id="monaco-container"></div>

                <!-- Terminal Panel -->
                <div class="terminal-panel" id="terminal-panel">
                    <div class="resize-handle" id="terminal-resize"></div>
                    <div class="terminal-header" id="terminal-header">
                        <div class="terminal-tabs">
                            <span class="terminal-tab active" data-panel="terminal">
                                <i class="fa-solid fa-terminal"></i> Terminal
                            </span>
                            <span class="terminal-tab" data-panel="problems">
                                <i class="fa-solid fa-triangle-exclamation"></i> Problems
                            </span>
                        </div>
                        <button class="sidebar-btn" id="terminal-toggle">
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="terminal-content" id="terminal-content">
                        <div class="terminal-line info">> Phantom Code Editor v1.0.0</div>
                        <div class="terminal-line">> Ready to code. Drag files or start typing...</div>
                    </div>
                    <div class="terminal-content problems-content" id="problems-content">
                        <div style="color: var(--text-muted); text-align: center; padding: 20px;">
                            No problems detected. Click "Check Errors" to lint your code.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monaco Editor CDN -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            files: new Map(),
            activeFile: 'untitled.js',
            editor: null,
            markers: [],
            activePanel: 'terminal'
        };

        // Default starter file
        state.files.set('untitled.js', {
            content: `// Welcome to Phantom Code Editor!
// Start coding or drag files here.

function greet(name) {
    console.log(\`Hello, \${name}!\`);
}

greet('World');
`,
            language: 'javascript'
        });

        // ============================================
        // VERIFY JSZIP LOADED
        // ============================================
        if (typeof JSZip === 'undefined') {
            console.warn('JSZip not loaded from head, attempting backup load...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
            document.head.appendChild(script);
        }

        // ============================================
        // SIMPLE LINTER (JavaScript/TypeScript)
        // ============================================
        function lintCode(code, language) {
            const problems = [];
            const lines = code.split('\n');

            if (language === 'javascript' || language === 'typescript') {
                lines.forEach((line, i) => {
                    const lineNum = i + 1;
                    const trimmed = line.trim();

                    // Check for console.log (warning)
                    if (trimmed.includes('console.log')) {
                        problems.push({
                            type: 'warning',
                            line: lineNum,
                            column: line.indexOf('console.log') + 1,
                            message: 'Avoid using console.log in production code'
                        });
                    }

                    // Check for var usage (warning)
                    if (/\bvar\s+/.test(line)) {
                        problems.push({
                            type: 'warning',
                            line: lineNum,
                            column: line.indexOf('var') + 1,
                            message: 'Use "let" or "const" instead of "var"'
                        });
                    }

                    // Check for == instead of === (warning)
                    if (/[^=!]==[^=]/.test(line)) {
                        problems.push({
                            type: 'warning',
                            line: lineNum,
                            column: line.indexOf('==') + 1,
                            message: 'Use "===" instead of "==" for strict equality'
                        });
                    }

                    // Check for != instead of !== (warning)
                    if (/[^!]!=[^=]/.test(line)) {
                        problems.push({
                            type: 'warning',
                            line: lineNum,
                            column: line.indexOf('!=') + 1,
                            message: 'Use "!==" instead of "!=" for strict inequality'
                        });
                    }

                    // Check for debugger statement (error)
                    if (trimmed.includes('debugger')) {
                        problems.push({
                            type: 'error',
                            line: lineNum,
                            column: line.indexOf('debugger') + 1,
                            message: 'Remove debugger statement'
                        });
                    }

                    // Check for trailing whitespace (info)
                    if (line.endsWith(' ') || line.endsWith('\t')) {
                        problems.push({
                            type: 'warning',
                            line: lineNum,
                            column: line.length,
                            message: 'Trailing whitespace'
                        });
                    }

                    // Check for TODO/FIXME comments
                    if (/\/\/\s*(TODO|FIXME|HACK|XXX)/i.test(line)) {
                        problems.push({
                            type: 'warning',
                            line: lineNum,
                            column: 1,
                            message: 'Found TODO/FIXME comment'
                        });
                    }

                    // Check for empty catch blocks
                    if (/catch\s*\([^)]*\)\s*\{\s*\}/.test(line)) {
                        problems.push({
                            type: 'error',
                            line: lineNum,
                            column: line.indexOf('catch') + 1,
                            message: 'Empty catch block - handle or log the error'
                        });
                    }
                });
            }

            return problems;
        }

        function updateProblemsPanel(problems) {
            const content = document.getElementById('problems-content');
            const errorCount = document.getElementById('error-count');
            const warningCount = document.getElementById('warning-count');

            const errors = problems.filter(p => p.type === 'error').length;
            const warnings = problems.filter(p => p.type === 'warning').length;

            errorCount.textContent = `${errors} error${errors !== 1 ? 's' : ''}`;
            errorCount.style.display = errors > 0 ? 'inline' : 'none';

            warningCount.textContent = `${warnings} warning${warnings !== 1 ? 's' : ''}`;
            warningCount.style.display = warnings > 0 ? 'inline' : 'none';

            if (problems.length === 0) {
                content.innerHTML = `
                    <div style="color: var(--text-muted); text-align: center; padding: 20px;">
                        <i class="fa-solid fa-check-circle" style="color: #22c55e; font-size: 1.5rem; display: block; margin-bottom: 8px;"></i>
                        No problems found!
                    </div>
                `;
            } else {
                content.innerHTML = problems.map(p => `
                    <div class="problem-item ${p.type}" data-line="${p.line}">
                        <i class="fa-solid fa-${p.type === 'error' ? 'circle-xmark' : 'triangle-exclamation'}"></i>
                        <span class="problem-text">${p.message}</span>
                        <span class="problem-location">Ln ${p.line}, Col ${p.column}</span>
                    </div>
                `).join('');

                // Click to jump to line
                content.querySelectorAll('.problem-item').forEach(item => {
                    item.onclick = () => {
                        const line = parseInt(item.dataset.line);
                        if (state.editor) {
                            state.editor.revealLineInCenter(line);
                            state.editor.setPosition({ lineNumber: line, column: 1 });
                            state.editor.focus();
                        }
                    };
                });
            }

            // Update Monaco markers
            if (state.editor && window.monaco) {
                const model = state.editor.getModel();
                const markers = problems.map(p => ({
                    severity: p.type === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
                    startLineNumber: p.line,
                    startColumn: p.column,
                    endLineNumber: p.line,
                    endColumn: p.column + 10,
                    message: p.message,
                    source: 'Phantom Lint'
                }));
                monaco.editor.setModelMarkers(model, 'phantom-lint', markers);
            }
        }

        // ============================================
        // MONACO EDITOR SETUP
        // ============================================
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            // Define Phantom dark theme
            monaco.editor.defineTheme('phantom-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '6a737d', fontStyle: 'italic' },
                    { token: 'keyword', foreground: 'c084fc' },
                    { token: 'string', foreground: '22c55e' },
                    { token: 'number', foreground: 'f59e0b' },
                    { token: 'function', foreground: '60a5fa' }
                ],
                colors: {
                    'editor.background': '#0a0a0a',
                    'editor.foreground': '#e4e4e7',
                    'editor.lineHighlightBackground': '#1a1a1a',
                    'editor.selectionBackground': '#3b82f640',
                    'editorCursor.foreground': '#ffffff',
                    'editorLineNumber.foreground': '#52525b',
                    'editorLineNumber.activeForeground': '#a1a1aa'
                }
            });

            // Create editor
            state.editor = monaco.editor.create(document.getElementById('monaco-container'), {
                value: state.files.get('untitled.js').content,
                language: 'javascript',
                theme: 'phantom-dark',
                fontSize: 14,
                fontFamily: "'JetBrains Mono', 'Fira Code', 'Consolas', monospace",
                minimap: { enabled: true },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                tabSize: 4,
                insertSpaces: true,
                wordWrap: 'on',
                lineNumbers: 'on',
                renderWhitespace: 'selection',
                bracketPairColorization: { enabled: true },
                formatOnPaste: true,
                formatOnType: true
            });

            // Save content on change
            state.editor.onDidChangeModelContent(() => {
                if (state.activeFile && state.files.has(state.activeFile)) {
                    state.files.get(state.activeFile).content = state.editor.getValue();
                }
            });

            // Show welcome notification
            if (window.Notify) {
                Notify.info('Code Editor', 'Welcome! Drag files or start coding.');
            }

            logTerminal('Monaco Editor initialized', 'info');
            logTerminal('JSZip ' + (typeof JSZip !== 'undefined' ? 'loaded ✓' : 'not loaded ✗'), typeof JSZip !== 'undefined' ? 'info' : 'error');
        });

        // ============================================
        // TERMINAL TAB SWITCHING
        // ============================================
        document.querySelectorAll('.terminal-tab').forEach(tab => {
            tab.onclick = (e) => {
                e.stopPropagation();
                document.querySelectorAll('.terminal-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const panel = tab.dataset.panel;
                state.activePanel = panel;

                document.getElementById('terminal-content').style.display = panel === 'terminal' ? 'block' : 'none';
                document.getElementById('problems-content').style.display = panel === 'problems' ? 'block' : 'none';
            };
        });

        // ============================================
        // FILE TREE MANAGEMENT
        // ============================================
        const fileTree = document.getElementById('file-tree');
        const editorTabs = document.getElementById('editor-tabs');

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'js': { icon: 'fa-brands fa-js', class: 'js-icon' },
                'ts': { icon: 'fa-brands fa-js', class: 'js-icon' },
                'html': { icon: 'fa-solid fa-code', class: 'html-icon' },
                'css': { icon: 'fa-brands fa-css3-alt', class: 'css-icon' },
                'json': { icon: 'fa-solid fa-brackets-curly', class: 'json-icon' },
                'md': { icon: 'fa-solid fa-file-lines', class: 'file-icon' },
                'txt': { icon: 'fa-solid fa-file-lines', class: 'file-icon' }
            };
            return icons[ext] || { icon: 'fa-solid fa-file', class: 'file-icon' };
        }

        function getLanguage(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const languages = {
                'js': 'javascript',
                'ts': 'typescript',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'md': 'markdown',
                'py': 'python',
                'txt': 'plaintext'
            };
            return languages[ext] || 'plaintext';
        }

        function renderFileTree() {
            if (state.files.size === 0) {
                fileTree.innerHTML = `
                    <div class="file-tree-empty">
                        <i class="fa-solid fa-folder-open"></i>
                        <span>Drag & drop files or folders here<br>or click + to create new</span>
                    </div>
                `;
                return;
            }

            let html = '';
            state.files.forEach((data, filename) => {
                const iconData = getFileIcon(filename);
                const isActive = filename === state.activeFile;
                html += `
                    <div class="tree-item ${isActive ? 'active' : ''}" data-file="${filename}">
                        <i class="${iconData.icon} ${iconData.class}"></i>
                        <span>${filename}</span>
                    </div>
                `;
            });
            fileTree.innerHTML = html;

            fileTree.querySelectorAll('.tree-item').forEach(item => {
                item.onclick = () => openFile(item.dataset.file);
            });
        }

        function renderTabs() {
            let html = '';
            state.files.forEach((data, filename) => {
                const iconData = getFileIcon(filename);
                const isActive = filename === state.activeFile;
                html += `
                    <button class="editor-tab ${isActive ? 'active' : ''}" data-file="${filename}">
                        <i class="${iconData.icon} ${iconData.class}"></i>
                        ${filename}
                        <span class="close-tab" data-close="${filename}"><i class="fa-solid fa-xmark"></i></span>
                    </button>
                `;
            });
            editorTabs.innerHTML = html;

            editorTabs.querySelectorAll('.editor-tab').forEach(tab => {
                tab.onclick = (e) => {
                    if (e.target.closest('.close-tab')) {
                        closeFile(e.target.closest('.close-tab').dataset.close);
                    } else {
                        openFile(tab.dataset.file);
                    }
                };
            });
        }

        function openFile(filename) {
            if (!state.files.has(filename)) return;

            state.activeFile = filename;
            const fileData = state.files.get(filename);

            if (state.editor) {
                monaco.editor.setModelLanguage(state.editor.getModel(), fileData.language);
                state.editor.setValue(fileData.content);
            }

            // Update language selector
            document.getElementById('language-select').value = fileData.language;
            renderFileTree();
            renderTabs();
        }

        function closeFile(filename) {
            if (state.files.size <= 1) {
                if (window.Notify) Notify.warning('Cannot close', 'At least one file must remain open');
                return;
            }

            state.files.delete(filename);

            if (state.activeFile === filename) {
                state.activeFile = state.files.keys().next().value;
                openFile(state.activeFile);
            }

            renderFileTree();
            renderTabs();
            logTerminal(`Closed: ${filename}`);
        }

        function addFile(filename, content = '') {
            const language = getLanguage(filename);
            state.files.set(filename, { content, language });
            renderFileTree();
            renderTabs();
            openFile(filename);
            logTerminal(`Added: ${filename}`, 'info');
        }

        // ============================================
        // DRAG AND DROP
        // ============================================
        fileTree.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileTree.classList.add('drag-over');
        });

        fileTree.addEventListener('dragleave', () => {
            fileTree.classList.remove('drag-over');
        });

        fileTree.addEventListener('drop', async (e) => {
            e.preventDefault();
            fileTree.classList.remove('drag-over');

            const items = e.dataTransfer.items;

            for (const item of items) {
                if (item.kind === 'file') {
                    const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;

                    if (entry) {
                        await processEntry(entry);
                    } else {
                        const file = item.getAsFile();
                        if (file) {
                            await readFile(file);
                        }
                    }
                }
            }

            if (window.Notify) Notify.success('Files added', 'Files have been loaded into the editor');
        });

        async function processEntry(entry, path = '') {
            if (entry.isFile) {
                entry.file(async (file) => {
                    const filename = path ? `${path}/${file.name}` : file.name;
                    await readFileWithName(file, filename);
                });
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const entries = await new Promise((resolve) => {
                    reader.readEntries(resolve);
                });

                for (const subEntry of entries) {
                    await processEntry(subEntry, path ? `${path}/${entry.name}` : entry.name);
                }
            }
        }

        async function readFile(file) {
            await readFileWithName(file, file.name);
        }

        async function readFileWithName(file, filename) {
            try {
                const content = await file.text();
                addFile(filename, content);
            } catch (err) {
                logTerminal(`Error reading ${filename}: ${err.message}`, 'error');
            }
        }

        // ============================================
        // NEW FILE / FOLDER
        // ============================================
        document.getElementById('new-file-btn').onclick = () => {
            const filename = prompt('Enter filename:', 'newfile.js');
            if (filename) {
                addFile(filename, '');
            }
        };

        document.getElementById('new-folder-btn').onclick = () => {
            if (window.Notify) {
                Notify.info('Folders', 'Drag and drop a folder to add it, or create files with paths like "folder/file.js"');
            }
        };

        // ============================================
        // LANGUAGE SELECTOR
        // ============================================
        document.getElementById('language-select').onchange = (e) => {
            const newLanguage = e.target.value;
            if (state.editor && state.activeFile && state.files.has(state.activeFile)) {
                // Update the file's language
                state.files.get(state.activeFile).language = newLanguage;
                // Update Monaco editor language
                monaco.editor.setModelLanguage(state.editor.getModel(), newLanguage);
                logTerminal(`Language changed to ${newLanguage}`, 'info');
            }
        };

        // ============================================
        // OPEN IN NEW TAB
        // ============================================
        document.getElementById('open-tab-btn').onclick = () => {
            if (!state.activeFile || !state.files.has(state.activeFile)) return;

            const fileData = state.files.get(state.activeFile);
            const content = fileData.content;
            const language = fileData.language;

            // Determine MIME type
            const mimeTypes = {
                'html': 'text/html',
                'css': 'text/css',
                'javascript': 'text/javascript',
                'json': 'application/json',
                'markdown': 'text/markdown',
                'plaintext': 'text/plain'
            };
            const mimeType = mimeTypes[language] || 'text/plain';

            // Create blob and open in new tab
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);

            // For HTML, open directly. For others, wrap in a simple HTML viewer
            if (language === 'html') {
                window.open(url, '_blank');
            } else {
                // Create a simple viewer for non-HTML files
                const viewerHtml = `<!DOCTYPE html>
<html>
<head>
    <title>${state.activeFile}</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: #e4e4e7; font-family: 'JetBrains Mono', monospace; }
        pre { margin: 0; padding: 20px; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <pre>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
</body>
</html>`;
                const viewerBlob = new Blob([viewerHtml], { type: 'text/html' });
                const viewerUrl = URL.createObjectURL(viewerBlob);
                window.open(viewerUrl, '_blank');
            }

            logTerminal(`Opened ${state.activeFile} in new tab`, 'info');
            if (window.Notify) Notify.success('Opened', `${state.activeFile} opened in new tab`);
        };

        // ============================================
        // FIX CODE (Format + AutoFix basic issues)
        // ============================================
        document.getElementById('fix-code-btn').onclick = async () => {
            if (!state.editor) return;

            try {
                // Format using Monaco
                await state.editor.getAction('editor.action.formatDocument').run();

                // Get current code and apply simple fixes
                let code = state.editor.getValue();
                const language = state.files.get(state.activeFile)?.language || 'javascript';

                if (language === 'javascript' || language === 'typescript') {
                    // Fix var -> let
                    code = code.replace(/\bvar\s+/g, 'let ');

                    // Fix == to === (be careful with existing ===)
                    code = code.replace(/([^=!])={2}([^=])/g, '$1===$2');
                    code = code.replace(/([^!])!={1}([^=])/g, '$1!==$2');

                    // Remove trailing whitespace
                    code = code.split('\n').map(line => line.trimEnd()).join('\n');

                    state.editor.setValue(code);
                }

                logTerminal('Code formatted and fixed!', 'info');
                if (window.Notify) Notify.success('Fixed', 'Code has been formatted and auto-fixed');

                // Re-run lint to show remaining issues
                const problems = lintCode(code, language);
                updateProblemsPanel(problems);

            } catch (err) {
                logTerminal(`Format error: ${err.message}`, 'error');
                if (window.Notify) Notify.error('Format failed', err.message);
            }
        };

        // ============================================
        // LINT CODE
        // ============================================
        document.getElementById('lint-btn').onclick = () => {
            if (!state.editor) return;

            const code = state.editor.getValue();
            const language = state.files.get(state.activeFile)?.language || 'javascript';

            const problems = lintCode(code, language);
            updateProblemsPanel(problems);

            // Switch to problems panel
            document.querySelectorAll('.terminal-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.terminal-tab[data-panel="problems"]').classList.add('active');
            document.getElementById('terminal-content').style.display = 'none';
            document.getElementById('problems-content').style.display = 'block';

            const errorCount = problems.filter(p => p.type === 'error').length;
            const warningCount = problems.filter(p => p.type === 'warning').length;

            logTerminal(`Lint complete: ${errorCount} errors, ${warningCount} warnings`, errorCount > 0 ? 'error' : (warningCount > 0 ? 'warning' : 'info'));

            if (window.Notify) {
                if (errorCount > 0) {
                    Notify.error('Lint Results', `Found ${errorCount} error(s) and ${warningCount} warning(s)`);
                } else if (warningCount > 0) {
                    Notify.warning('Lint Results', `Found ${warningCount} warning(s)`);
                } else {
                    Notify.success('Lint Results', 'No problems found!');
                }
            }
        };

        // ============================================
        // SAVE FILE
        // ============================================
        document.getElementById('save-btn').onclick = () => {
            if (!state.activeFile || !state.files.has(state.activeFile)) return;

            const content = state.files.get(state.activeFile).content;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = state.activeFile;
            a.click();

            URL.revokeObjectURL(url);
            logTerminal(`Saved: ${state.activeFile}`, 'info');
            if (window.Notify) Notify.success('Saved', `Downloaded ${state.activeFile}`);
        };

        // ============================================
        // EXPORT PROJECT (ZIP)
        // ============================================
        document.getElementById('export-btn').onclick = async () => {
            if (typeof JSZip === 'undefined') {
                logTerminal('JSZip not available, attempting reload...', 'warning');
                if (window.Notify) Notify.warning('Loading...', 'Loading JSZip library...');

                // Try to load JSZip dynamically
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                // Wait a bit for it to initialize
                await new Promise(r => setTimeout(r, 500));

                if (typeof JSZip === 'undefined') {
                    logTerminal('Failed to load JSZip', 'error');
                    if (window.Notify) Notify.error('Error', 'Could not load JSZip library');
                    return;
                }
            }

            logTerminal('Creating ZIP archive...', 'info');

            const zip = new JSZip();

            state.files.forEach((data, filename) => {
                zip.file(filename, data.content);
            });

            try {
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'project.zip';
                a.click();

                URL.revokeObjectURL(url);
                logTerminal('Project exported as project.zip', 'info');
                if (window.Notify) Notify.success('Exported', 'Project downloaded as project.zip');
            } catch (err) {
                logTerminal(`Export error: ${err.message}`, 'error');
                if (window.Notify) Notify.error('Export failed', err.message);
            }
        };

        // ============================================
        // TERMINAL
        // ============================================
        const terminalPanel = document.getElementById('terminal-panel');
        const terminalContent = document.getElementById('terminal-content');
        const terminalToggle = document.getElementById('terminal-toggle');

        document.getElementById('terminal-header').onclick = (e) => {
            if (e.target.closest('.terminal-tab')) return; // Don't toggle when clicking tabs
            terminalPanel.classList.toggle('collapsed');
            const icon = terminalToggle.querySelector('i');
            icon.className = terminalPanel.classList.contains('collapsed')
                ? 'fa-solid fa-chevron-up'
                : 'fa-solid fa-chevron-down';
        };

        function logTerminal(message, type = '') {
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            line.textContent = `> ${message}`;
            terminalContent.appendChild(line);
            terminalContent.scrollTop = terminalContent.scrollHeight;
        }

        // Terminal resize
        let isResizing = false;
        document.getElementById('terminal-resize').addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'ns-resize';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const container = document.querySelector('.editor-main');
            const newHeight = container.getBoundingClientRect().bottom - e.clientY;
            if (newHeight >= 100 && newHeight <= 500) {
                terminalPanel.style.height = newHeight + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = '';
        });

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Ctrl+S = Save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                document.getElementById('save-btn').click();
            }
            // Ctrl+Shift+F = Format
            if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                document.getElementById('fix-code-btn').click();
            }
            // Ctrl+Shift+L = Lint
            if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                e.preventDefault();
                document.getElementById('lint-btn').click();
            }
        });

        // Initial render
        renderFileTree();
        renderTabs();

        // Apply settings
        if (window.Settings) {
            Settings.apply();
        }
    </script>

    <script src="../components/footer.js"></script>
</body>

</html>